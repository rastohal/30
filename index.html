<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Pestros≈• stravy</title>
<link rel="manifest" href="manifest.json" />
<style>
  body {
    font-family: system-ui, sans-serif;
    background: #faf8f6;
    color: #2d2a26;
    margin: 0;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  h1 { margin-bottom: 0.5rem; }
  input {
    padding: 0.5rem;
    font-size: 1rem;
    width: 90%;
    border-radius: 8px;
    border: 1px solid #ccc;
    outline: none;
  }
  button {
    margin-top: 0.5rem;
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 8px;
    background-color: #6b705c;
    color: white;
    font-size: 1rem;
  }
  ul { list-style: none; padding: 0; width: 90%; }
  li {
    margin: 0.3rem 0;
    padding: 0.5rem;
    border-radius: 8px;
    color: #fff;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .actions button {
    background: none;
    border: none;
    font-size: 1.2rem;
    cursor: pointer;
  }
  #suggestions {
    background: white;
    border: 1px solid #ccc;
    border-radius: 8px;
    width: 90%;
    position: absolute;
    z-index: 10;
  }
  #suggestions div {
    padding: 0.4rem;
    cursor: pointer;
  }
  #suggestions div:hover {
    background-color: #eee;
  }
  #statsSection {
    display: none;
    text-align: center;
    width: 90%;
  }
  #exportBtn { margin-top: 1rem; }
  nav {
    margin: 1rem 0;
    display: flex;
    gap: 1rem;
  }
  nav button {
    background-color: #a5a58d;
  }
</style>
</head>
<body>
  <h1>Pestros≈• stravy</h1>
  <nav>
    <button id="showListBtn">ü•ï Zoznam</button>
    <button id="showStatsBtn">üìä ≈†tatistiky</button>
  </nav>

  <section id="listSection">
    <input id="foodInput" type="text" placeholder="Zadaj potravinu..." autocomplete="off" />
    <div id="suggestions"></div>
    <ul id="foodList"></ul>
    <button id="exportBtn">üì§ Export CSV</button>
  </section>

  <section id="statsSection">
    <h2>≈†tatistiky</h2>
    <p>üìÖ Poƒçet r√¥znych potrav√≠n (7 dn√≠): <span id="uniqueCount">0</span></p>
    <p>üî¢ Shannonov index: <span id="shannonIndex">0.00</span></p>
    <p><small>Vzorec: H = -Œ£(p·µ¢ * ln(p·µ¢)), kde p·µ¢ = podiel v√Ωskytu potraviny.<br>
    Vy≈°≈°ie H znamen√° vyrovnanej≈°iu a pestrej≈°iu stravu.</small></p>
  </section>

<script>
  const foodInput = document.getElementById('foodInput');
  const foodListEl = document.getElementById('foodList');
  const suggestionsEl = document.getElementById('suggestions');
  let foods = JSON.parse(localStorage.getItem('foods') || '[]');

  const dayMs = 24 * 60 * 60 * 1000;
  const now = () => new Date().getTime();

  function saveFoods() {
    localStorage.setItem('foods', JSON.stringify(foods));
  }

  function getColor(days) {
    const palette = ['#8bc34a','#c0ca33','#fbc02d','#ff9800','#f57c00','#e64a19','#7b1fa2','#888'];
    if (days > 7) return palette[7];
    return palette[days];
  }

  function renderFoods() {
    const listEl = document.getElementById('foodList');
    listEl.innerHTML = '';
    const nowT = now();
    const active = [], expired = [];

    foods.forEach(f => {
      const diff = Math.floor((nowT - f.timestamp) / dayMs);
      (diff <= 7 ? active : expired).push({...f, diff});
    });

    active.sort((a,b)=>a.name.localeCompare(b.name));
    expired.sort((a,b)=>a.name.localeCompare(b.name));
    const sorted = [...active, ...expired];

    sorted.forEach(f => {
      const li = document.createElement('li');
      li.style.background = getColor(f.diff);
      li.innerHTML = `
        <span>${f.name}</span>
        <span class="actions">
          <button onclick="refreshItem('${f.name}')">‚úÖ</button>
          <button onclick="deleteItem('${f.name}')">‚ùå</button>
        </span>
      `;
      listEl.appendChild(li);
    });

    saveFoods();
  }

  function addOrUpdateFood(name) {
    name = name.trim().toLowerCase();
    if (!name) return;
    const existing = foods.find(f => f.name === name);
    if (existing) {
      existing.timestamp = now();
    } else {
      foods.push({ name, timestamp: now(), history: [now()] });
    }
    renderFoods();
  }

  function refreshItem(name) {
    const item = foods.find(f => f.name === name);
    if (item) {
      item.timestamp = now();
      item.history.push(now());
      renderFoods();
    }
  }

  function deleteItem(name) {
    foods = foods.filter(f => f.name !== name);
    renderFoods();
  }

  foodInput.addEventListener('input', () => {
    const val = foodInput.value.toLowerCase();
    suggestionsEl.innerHTML = '';
    if (!val) return;
    const matches = foods.filter(f => f.name.startsWith(val));
    matches.forEach(f => {
      const div = document.createElement('div');
      div.textContent = f.name;
      div.onclick = () => {
        addOrUpdateFood(f.name);
        foodInput.value = '';
        suggestionsEl.innerHTML = '';
      };
      suggestionsEl.appendChild(div);
    });
  });

  foodInput.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      addOrUpdateFood(foodInput.value);
      foodInput.value = '';
      suggestionsEl.innerHTML = '';
    }
  });

  // CSV export
  document.getElementById('exportBtn').addEventListener('click', () => {
    const rows = [['nazov_potraviny','pocet_dni_kedy_bola_jedena','pred_kolkymi_dnami_bola_prvy_raz_jedena']];
    const nowT = now();
    foods.forEach(f => {
      const uniqueDays = new Set(f.history.map(t => Math.floor(t / dayMs)));
      const first = Math.min(...f.history);
      const daysAgo = Math.floor((nowT - first) / dayMs);
      rows.push([f.name, uniqueDays.size, daysAgo]);
    });
    const csv = rows.map(r => r.join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'pestros≈•.csv';
    a.click();
  });

  // Stats
  function updateStats() {
    const nowT = now();
    const recent = foods.filter(f => (nowT - f.timestamp) / dayMs <= 7);
    const total = recent.length;
    const p = recent.map(_=>1/total);
    const H = -p.reduce((s,pi)=>s+pi*Math.log(pi),0);
    document.getElementById('uniqueCount').textContent = total;
    document.getElementById('shannonIndex').textContent = H.toFixed(2);
  }

  // Tabs fix
  const statsBtn = document.getElementById('showStatsBtn');
  const listBtn = document.getElementById('showListBtn');
  const statsSection = document.getElementById('statsSection');
  const listSection = document.getElementById('listSection');

  statsBtn.addEventListener('click', () => {
    const statsVisible = statsSection.style.display === 'block';
    if (statsVisible) {
      statsSection.style.display = 'none';
      listSection.style.display = 'block';
    } else {
      statsSection.style.display = 'block';
      listSection.style.display = 'none';
      updateStats();
    }
  });

  listBtn.addEventListener('click', () => {
    statsSection.style.display = 'none';
    listSection.style.display = 'block';
  });

  renderFoods();
</script>
</body>
</html>
